namespace convexmobile {
    void init_convex_logging();
};

[Error]
interface ClientError {
    InternalError(string msg);
    ConvexError(string data);
    ServerError(string msg);
};

enum WebSocketState {
    "Connected",
    "Connecting",
};

[Trait, WithForeign]
interface WebSocketStateSubscriber {        
    void on_state_change(WebSocketState state);
};

[Trait, WithForeign]
interface AuthTokenProvider {
    [Async, Throws=ClientError]
    string? fetch_token(boolean force_refresh);
};

interface MobileConvexClient {
    constructor(string deployment_url, string client_id, WebSocketStateSubscriber? web_socket_state_subscriber);

    [Async, Throws=ClientError]
    string query(string name, record<string, string> args);

    [Async, Throws=ClientError]
    SubscriptionHandle subscribe(string name, record<string, string> args, QuerySubscriber subscriber);

    [Async, Throws=ClientError]
    string mutation(string name, record<string, string> args);

    [Async, Throws=ClientError]
    string action(string name, record<string, string> args);

    [Async, Throws=ClientError]
    void set_auth(string? token);

    [Async, Throws=ClientError]
    void set_auth_callback(AuthTokenProvider? provider);
};

interface SubscriptionHandle {
    [Self=ByArc]
    void cancel();
};

[Trait, WithForeign]
interface QuerySubscriber {
    void on_update(string value);
    void on_error(string message, string? value);
};
